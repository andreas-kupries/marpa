# -*- tcl -*- tcl.tk//DSL tcltest//EN//2.0 tcl.tk//DSL tcltest//EN//2.0
## (c) 2017 Andreas Kupries
# # ## ### ##### ######## ############# #####################
## marpa::parser

kt check Tcl     8.5
kt check tcltest 2

kt require support debug
kt require support debug::caller
kt require support oo::util
kt require support TclOO

kt local   testing marpa

# # ## ### ##### ######## ############# #####################
## Activate method sequence checking for all instances
## Instances can dynamically activate method sequence checks too

oo::define marpa::parser mixin marpa::parser::sequencer

# # ## ### ##### ######## ############# #####################

kt source support/common.tcl
#kt source support/fake-lex.tcl
kt source support/grexample.tcl
#kt source support/fake-parse.tcl
kt source support/fake-store.tcl

# # ## ### ##### ######## ############# #####################
##  1 constructor/3 (semstore, semantics, upstream)
# # -- --- ----- -------- -------------
##  2 gate:/1       (obj)
##  3 symbols/1     (names)
##  4 action/*      (...)
##  5 rules/1       (rules)
##  6 parse/1       (start-sym)
# # -- --- ----- -------- -------------
##  7 enter/2       (syms semval)
##  8 eof/0         ()
# # -- --- ----- -------- -------------
##
## Sequence = 1([345]*2[345]*67*)?8

# # ## ### ##### ######## ############# #####################
## constructor - wrong args, initial state, calls

test marpa-parser-1.0.0 {constructor, wrong args, not enough} -body {
    marpa::parser new
} -returnCodes error -result {wrong # args: should be "marpa::parser new semstore semantics upstream"}

test marpa-parser-1.0.1 {constructor, wrong args, not enough} -body {
    marpa::parser new STORE
} -returnCodes error -result {wrong # args: should be "marpa::parser new semstore semantics upstream"}

test marpa-parser-1.0.2 {constructor, wrong args, not enough} -body {
    marpa::parser new STORE SEM
} -returnCodes error -result {wrong # args: should be "marpa::parser new semstore semantics upstream"}

test marpa-parser-1.0.3 {constructor, wrong args, too many} -body {
    marpa::parser new STORE SEM UP X
} -returnCodes error -result {wrong # args: should be "marpa::parser new semstore semantics upstream"}

# No state to query ?! CHECK

test marpa-parser-1.1 {constructor, sequencing} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER @
} -cleanup {
    PARSER destroy
    logged
} -result made

test marpa-parser-1.2 {constructor, externals} -body {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    logged
} -cleanup {
    PARSER destroy
} -result {}

test marpa-parser-1.3.0 {constructor, post-forbidden: enter} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER enter C V
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {Setup missing}

# # ## ### ##### ######## ############# #####################
## gate: - wrong args, state, sequencing

test marpa-parser-2.0.0 {gate:, wrong args, not enough} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER gate:
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER gate: gate"}

test marpa-parser-2.0.1 {gate:, wrong args, too many} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER gate: OBJ X
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER gate: gate"}

test marpa-parser-2.1.0 {gate:, result} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER gate: [log GATE]
} -cleanup {
    PARSER destroy
    logged
} -result {}

test marpa-parser-2.1.1 {gate:, externals} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    logclear
} -body {
    PARSER gate: [log GATE]
    logged
} -cleanup {
    PARSER destroy
} -result {}

test marpa-parser-2.1.2 {gate:, sequencing} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER gate: [log GATE]
    PARSER @
} -cleanup {
    PARSER destroy
    logged
} -result gated

# post-forbidden - see constructor (state: gated)

# # ## ### ##### ######## ############# #####################
## action - wrong args, state, sequencing

test marpa-parser-3.0.0 {action, wrong args, not enough} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER action
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER action names"}

test marpa-parser-3.0.1 {action, wrong args, too many} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER action NAMES X
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER action names"}

test marpa-parser-3.1.0 {action, result} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER action {}
} -cleanup {
    PARSER destroy
    logged
} -result {}

test marpa-parser-3.1.1 {action, externals} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    logclear
} -body {
    PARSER action {}
    logged
} -cleanup {
    PARSER destroy
} -result {}

test marpa-parser-3.1.2 {action, sequencing, pre gate} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER action {}
    PARSER @
} -cleanup {
    PARSER destroy
    logged
} -result made

test marpa-parser-3.1.3 {action, sequencing, post gate} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    PARSER gate: [log GATE]
} -body {
    PARSER action {}
    PARSER @
} -cleanup {
    PARSER destroy
    logged
} -result gated

# post-forbidden - see constructor (state: made)

# # ## ### ##### ######## ############# #####################
## symbols - wrong args, state, sequencing

test marpa-parser-4.0.0 {symbols, wrong args, not enough} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER symbols
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER symbols names"}

test marpa-parser-4.0.1 {symbols, wrong args, too many} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER symbols NAMES X
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER symbols names"}

test marpa-parser-4.1.0 {symbols, result} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER symbols {a b}
} -cleanup {
    PARSER destroy
    logged
} -result {0 1}

test marpa-parser-4.1.1 {symbols, externals} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    logclear
} -body {
    PARSER symbols {a b}
    logged
} -cleanup {
    PARSER destroy
} -result {}

test marpa-parser-4.1.2 {symbols, sequencing, pre gate} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER symbols {a b}
    PARSER @
} -cleanup {
    PARSER destroy
    logged
} -result made

test marpa-parser-4.1.3 {symbols, sequencing, post gate} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    PARSER gate: [log GATE]
} -body {
    PARSER symbols {a b}
    PARSER @
} -cleanup {
    PARSER destroy
    logged
} -result gated

# post-forbidden - see constructor (state: made)

# # ## ### ##### ######## ############# #####################
## rules - wrong args, state, sequencing

test marpa-parser-5.0.0 {rules, wrong args, not enough} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER rules
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER rules rules"}

test marpa-parser-5.0.1 {rules, wrong args, too many} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER rules NAMES X
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER rules rules"}

test marpa-parser-5.1.0 {rules, result} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER rules {}
} -cleanup {
    PARSER destroy
    logged
} -result {}

test marpa-parser-5.1.1 {rules, externals} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    logclear
} -body {
    PARSER rules {}
    logged
} -cleanup {
    PARSER destroy
} -result {}

test marpa-parser-5.1.2 {rules, sequencing, pre gate} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER rules {}
    PARSER @
} -cleanup {
    PARSER destroy
    logged
} -result made

test marpa-parser-5.1.3 {rules, sequencing, post gate} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    PARSER gate: [log GATE]
} -body {
    PARSER rules {}
    PARSER @
} -cleanup {
    PARSER destroy
    logged
} -result gated

# TODO: rule commands (i.e. structure of the rules given to the method)

# post-forbidden - see constructor (state: made)

# # ## ### ##### ######## ############# #####################
## parse - wrong args, state, sequencing

test marpa-parser-6.0.0 {parse, wrong args, not enough} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER parse
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER parse name whitespace"}

test marpa-parser-6.0.1 {parse, wrong args, not enough} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER parse NAME
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER parse name whitespace"}

test marpa-parser-6.0.2 {parse, wrong args, too many} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
} -body {
    PARSER parse NAME WHITESPACE X
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {wrong # args: should be "PARSER parse name whitespace"}

test marpa-parser-6.2.0 {parse, no gate} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    GGBase PARSER
} -body {
    PARSER parse NAME W
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {Lexer missing}

test marpa-parser-6.3.0 {parse, post gate, result} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    GGBase PARSER W
    PARSER gate: [log GATE]
    logclear
} -body {
    PARSER parse NAME W
} -cleanup {
    PARSER destroy
} -result {}

test marpa-parser-6.3.1 {parse, post gate, externals} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    GGBase PARSER
    PARSER gate: [log GATE]
    logclear
} -body {
    PARSER parse NAME W
    logged
} -cleanup {
    PARSER destroy
} -result {
  GATE C {discard W}
  GATE R {discard W} = {}
  GATE C {acceptable {3 4}}
  GATE R {acceptable {3 4}} = {}
}

test marpa-parser-6.3.2 {parse, post gate, sequencing} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    GGBase PARSER
    PARSER gate: [log GATE]
} -body {
    PARSER parse NAME {}
    PARSER @
} -cleanup {
    PARSER destroy
    logged
} -result active

test marpa-parser-6.4.0 {parse, post-forbidden: gate:} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    GG PARSER
} -body {
    PARSER gate: [log GATE]
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {Parser is frozen}

test marpa-parser-6.4.1 {parse, post-forbidden: symbols} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    GG PARSER
} -body {
    PARSER symbols {}
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {Parser is frozen}

test marpa-parser-6.4.2 {parse, post-forbidden: action} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    GG PARSER
} -body {
    PARSER action {}
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {Parser is frozen}

test marpa-parser-6.4.3 {parse, post-forbidden: rules} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    GG PARSER
} -body {
    PARSER rules {}
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {Parser is frozen}

test marpa-parser-6.4.4 {parse, post-forbidden: parse} -setup {
    marpa::parser create PARSER [log STORE] [log SEM] [log UP]
    GG PARSER
} -body {
    PARSER parse NAME {}
} -cleanup {
    PARSER destroy
    logged
} -returnCodes error -result {Parser is frozen}

# # ## ### ##### ######## ############# #####################
cleanupTests
